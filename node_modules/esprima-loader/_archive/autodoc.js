var transform = require('./transform');
var makeIdentitySourceMap = require('./makeIdentitySourceMap');

module.exports = function(source, map) {
  if (this.cacheable) {
    this.cacheable();
  }
  var resourcePath = this.resourcePath;
  var separator = '\n\n';
  var result;

  var prependText = (
    '/* AUTODOC */\n' +
    'var AnnotatePropTypes = require(' +
      JSON.stringify(require.resolve('./annotate')) +
    ');'
  );

  source = transform(source);

  var result = [
    prependText,
    source
  ].join(separator);

  if (this.sourceMap === false) {
    return this.callback(null, result);
  }

  if (!map) {
    map = makeIdentitySourceMap(source, this.resourcePath);
  }

  var result = {
    code: source,
    map: {toString: function() { return result; }},
  };

  this.callback(null, result.code, result.map.toString());
};

